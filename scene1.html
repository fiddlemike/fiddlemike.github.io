<!DOCTYPE html>
<html lang="en">
<script>
  function handleLoad(e) {
    console.log('Loaded import: ' + e.target.href);
  }

  function handleError(e) {
    console.log('Error loading import: ' + e.target.href);
  }
</script>

<head>
  <link rel="import" href="./templates/head.html" id="head" onload="handleLoad(event)" onerror="handleError(event)">
  <link rel="import" href="./templates/footer.html" id="std-footer" onload="handleLoad(event)" onerror="handleError(event)">
  <link rel="import" href="./templates/header.html" id="std-header" onload="handleLoad(event)" onerror="handleError(event)">
  <link rel="stylesheet" href="css/barchart.css">

</head>

<body class="container">
  <header id="header">
    <script>
      // Get the link element that references the header.html file.
      var headerTemplate = document.getElementById('std-header');
      // Retrieve the loaded templates.
      var templates = headerTemplate.import
      // Get the template.
      var template = templates.getElementById('std-header');
      if (template) {
        // Clone the templates contents
        var clone = document.importNode(template.content, true);
        // Add the template code to the page header
        document.getElementById('header').appendChild(clone);
      } else {
        console.log('unable to access template.');
      }
    </script>
  </header>

  <main class "flex_container">

    <div class="menu sticky-top p-3 bg-light">
      <a href="/essay" target="_blank" class="btn btn-primary btn-lg active" role="button" aria-pressed="true">Essay</a>
      <p>Test of secondary header</p>
    </div>

    <div id="viz" class="barchart">
      <svg class="chart" width="960" height="500"></svg>
      <script>
        // set the dimensions and margins of the graph
        var svg = d3.select(".chart"),
          margin = {
            top: 20,
            right: 20,
            bottom: 30,
            left: 80
          },
          width = +svg.attr("width") - margin.left - margin.right,
          height = +svg.attr("height") - margin.top - margin.bottom;

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");
        // set the ranges
        var x = d3.scaleLinear().range([0, width]);
        var y = d3.scaleBand().range([height, 0]);

        var g = svg.append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // get the data
        d3.csv("data/incidents_by_year_and_state.csv", function(d) {
          return {
            year: d.year,
            state: d.state,
            freq: +d.freq // convert "freq" column to number
          };
        }, function(error, csv_data) {
          if (error) throw error;

          // console.log(data);
          var data = d3.nest()
            .key(function(d) {
              return d.state;
            })
            .rollup(function(d) {
              return d3.sum(d, function(g) {
                return g.freq;
              });
            }).entries(csv_data);

          /* Sort from highest to lowest*/
        //  data.sort(function(a, b) {
        //    return b.value - a.value;
      //    });

          // console.log(data);

          // Scale the range of the data in the domains
          x.domain([0, d3.max(data, function(d) {
            return d.value;
          })]);
          y.domain(data.map(function(d) {
            return d.key;
          }));

          // add the x Axis
          svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).ticks(5).tickFormat(function(d) {
              return parseInt(d / 1000);
            }).tickSizeInner([-height]));

          // add the y Axis
          svg.append("g")
            .attr("class", "y axis")
            .call(d3.axisLeft(y));

          // append the rectangles for the bar chart
          svg.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", 0)
            .attr("height", y.bandwidth())
            .attr("y", function(d) {
              return y(d.area);
            })
            .attr("width", function(d) {
              return x(d.value);
            })
            .on("mousemove", function(d) {
              tooltip
                .style("left", d3.event.pageX - 50 + "px")
                .style("top", d3.event.pageY - 70 + "px")
                .style("display", "inline-block")
                .html((d.key) + "<br>" + (d.value));
            })
            .on("mouseout", function(d) {
              tooltip.style("display", "none");
            });

        });
      </script>
    </div>

  </main>

  <footer id="footer">
    <script>
      // Get the link element that references the header.html file.
      var footerTemplate = document.getElementById('std-footer');
      // Retrieve the loaded templates.
      var templates = footerTemplate.import
      // Get the template.
      var template = templates.getElementById('std-footer');
      if (template) {
        // Clone the templates contents
        var clone = document.importNode(template.content, true);
        // Add the template code to the page header
        document.getElementById('footer').appendChild(clone);
      } else {
        console.log('unable to access template.');
      }
    </script>
  </footer>


</body>

</html>
